<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Tareas - Sistema Secretarios</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-primary: #1e3a8a;
            --color-primary-dark: #1e40af;
            --color-secondary: #3b82f6;
            --color-accent: #f59e0b;
            --color-text-light: #f8f9fa;
            --color-text-dark: #1f2937;
            --color-text-muted: #6b7280;
            --color-background: #f9fafb;
            --color-card: #ffffff;
            --color-success: #10b981;
            --color-border: #e5e7eb;
            --shadow-light: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-heavy: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
            --sidebar-width-expanded: 250px;
            --sidebar-width-collapsed: 80px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', 'Segoe UI', Tahoma, sans-serif; background-color: var(--color-background); color: var(--color-text-dark); line-height: 1.6; }

        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: var(--sidebar-width-expanded); background-color: var(--color-primary); color: var(--color-text-light); box-shadow: var(--shadow-heavy); position: fixed; top: 0; left: 0; height: 100%; display: flex; flex-direction: column; transition: width var(--transition); z-index: 1001; cursor: pointer; }
        .sidebar.collapsed { width: var(--sidebar-width-collapsed); }
        .sidebar-header { padding: 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar-header i { font-size: 1.8rem; }
        .sidebar-header h2 { font-size: 1.2rem; white-space: nowrap; overflow: hidden; transition: var(--transition); }
        .sidebar.collapsed .sidebar-header h2 { display: none; }
        .nav-btn { display: flex; align-items: center; padding: 15px 20px; color: var(--color-text-light); text-decoration: none; transition: var(--transition); border-left: 5px solid transparent; white-space: nowrap; font-weight: 500; }
        .nav-btn:hover, .nav-btn.active { background-color: rgba(255, 255, 255, 0.15); border-left-color: var(--color-accent); }
        .nav-btn i { margin-right: 15px; font-size: 1.2rem; min-width: 20px; }
        .sidebar.collapsed .nav-btn { justify-content: center; padding: 15px 0; }
        .sidebar.collapsed .nav-btn span { display: none; }
        .main-container { flex-grow: 1; display: flex; flex-direction: column; margin-left: var(--sidebar-width-expanded); transition: margin-left var(--transition); width: calc(100% - var(--sidebar-width-expanded)); }
        .main-container.sidebar-collapsed { margin-left: var(--sidebar-width-collapsed); width: calc(100% - var(--sidebar-width-collapsed)); }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; border-bottom: 1px solid var(--color-border); background-color: var(--color-card); }
        .app-logo { display: flex; align-items: center; gap: 15px; }
        .app-logo h1 { font-size: 1.5rem; color: var(--color-text-muted); font-weight: 600; transition: font-size 0.3s ease; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--color-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 10px 20px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: var(--transition); text-decoration: none; }
        .btn-success { background-color: var(--color-success); color: white; }
        .btn-accent { background-color: var(--color-accent); color: var(--color-text-dark); }
        .btn-outline { background-color: transparent; border: 2px solid var(--color-primary); color: var(--color-primary); }
        .main-content { flex: 1; padding: 30px; background-color: var(--color-background); }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid var(--color-border); }

        /* Estilos específicos para reportes */
        .filters-container { background-color: var(--color-card); padding: 20px; border-radius: var(--border-radius); margin-bottom: 30px; box-shadow: var(--shadow-light); }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background-color: var(--color-card); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow-light); text-align: center; border-left: 5px solid var(--color-primary); }
        .stat-number { font-size: 2.5rem; font-weight: 700; color: var(--color-primary); margin-bottom: 10px; }
        .stat-label { color: var(--color-text-muted); font-size: 0.9rem; }
        .report-section { background-color: var(--color-card); padding: 25px; border-radius: var(--border-radius); margin-bottom: 30px; box-shadow: var(--shadow-light); }
        .report-section h3 { color: var(--color-primary); margin-bottom: 20px; border-bottom: 2px solid var(--color-border); padding-bottom: 10px; }
        .chart-container { height: 300px; margin: 20px 0; }
        .simple-bar { background-color: var(--color-background); border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .bar-fill { height: 30px; background: linear-gradient(90deg, var(--color-primary), var(--color-secondary)); border-radius: 10px; transition: width 0.5s ease; display: flex; align-items: center; padding: 0 15px; color: white; font-weight: 600; }
        .list-container { display: flex; flex-direction: column; gap: 15px; }
        .list-item { background-color: var(--color-background); padding: 15px; border-radius: var(--border-radius); border-left: 5px solid var(--color-accent); }
        .list-item h4 { margin: 0 0 10px 0; color: var(--color-primary); font-size: 1.1rem; }
        .list-item p { margin: 5px 0; font-size: 0.9rem; color: var(--color-text-dark); }
    </style>
</head>
<body>
    <div class="app-container">
        <aside id="sidebar-nav" class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-balance-scale"></i>
                <h2>SISTEMA SECRETARIOS</h2>
            </div>
            
            <nav class="main-nav-sidebar">
                <a href="dashboard.html" class="nav-btn">
                    <i class="fas fa-home"></i> <span>Dashboard</span>
                </a>
                <a href="causas-verificadas.html" class="nav-btn">
                    <i class="fas fa-clipboard-check"></i> <span>Causas verificadas</span>
                </a>
                <a href="causas-antecedentes.html" class="nav-btn">
                    <i class="fas fa-history"></i> <span>Causas antecedentes</span>
                </a>
                <a href="causas-proteccion.html" class="nav-btn">
                    <i class="fas fa-shield-alt"></i> <span>Causas Protección</span>
                </a>
                <a href="actividades-judiciales.html" class="nav-btn">
                    <i class="fas fa-tasks"></i> <span>Actividades Judiciales</span>
                </a>
                <a href="entrevistas-clientes.html" class="nav-btn">
                    <i class="fas fa-users"></i> <span>Entrevistas Clientes</span>
                </a>
                <a href="agenda.html" class="nav-btn">
                    <i class="fas fa-calendar-alt"></i> <span>Agenda</span>
                </a>
                <a href="otras-tareas.html" class="nav-btn">
                    <i class="fas fa-ellipsis-h"></i> <span>Otras tareas</span>
                </a>
                <a href="reporte-tareas.html" class="nav-btn active">
                    <i class="fas fa-chart-bar"></i> <span>Reporte de tareas</span>
                </a>
                <a href="documentos.html" class="nav-btn">
                    <i class="fas fa-file-pdf"></i> <span>Documentos</span>
                </a>
                <a href="directorio-clientes.html" class="nav-btn">
                    <i class="fas fa-address-book"></i> <span>Directorio Clientes</span>
                </a>
                <a href="directorio-organismos.html" class="nav-btn">
                    <i class="fas fa-building"></i> <span>Directorio de Organismos</span>
                </a>
            </nav>
        </aside>

        <div id="main-container" class="main-container">
            <header class="app-header">
                <div class="top-bar">
                    <div class="app-logo">
                        <i class="fas fa-balance-scale"></i>
                        <h1>REPORTE DE TAREAS</h1>
                    </div>
                    <div class="user-info">
                        <span id="user-greeting">Bienvenido/a</span>
                        <div class="user-avatar" id="user-avatar">?</div>
                        <button id="logout-btn" class="btn btn-accent">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                        </button>
                    </div>
                </div>
            </header>

            <div class="main-content">
                <div class="content-header">
                    <h2>Dashboard de Reportes</h2>
                    <button id="export-btn" class="btn btn-success">
                        <i class="fas fa-download"></i> Exportar Reporte
                    </button>
                </div>

                <div class="filters-container">
                    <h3>Filtros del Reporte</h3>
                    <div class="filters-grid">
                        <div class="form-group">
                            <label for="fecha-desde">Desde:</label>
                            <input type="date" id="fecha-desde" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="fecha-hasta">Hasta:</label>
                            <input type="date" id="fecha-hasta" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="tipo-reporte">Tipo de Actividad:</label>
                            <select id="tipo-reporte" class="form-control">
                                <option value="todos">Todos</option>
                                <option value="actividades-judiciales">Actividades Judiciales</option>
                                <option value="entrevistas-clientes">Entrevistas</option>
                                <option value="otras-tareas">Otras Tareas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="estado-reporte">Estado:</label>
                            <select id="estado-reporte" class="form-control">
                                <option value="todos">Todos</option>
                                <option value="cumplido">Cumplidos</option>
                                <option value="pendiente">Pendientes</option>
                            </select>
                        </div>
                    </div>
                    <button id="aplicar-filtros" class="btn btn-primary" style="margin-top: 15px;">
                        <i class="fas fa-filter"></i> Aplicar Filtros
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-tareas">0</div>
                        <div class="stat-label">Total de Tareas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="tareas-cumplidas">0</div>
                        <div class="stat-label">Tareas Cumplidas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="tareas-pendientes">0</div>
                        <div class="stat-label">Tareas Pendientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="porcentaje-cumplimiento">0%</div>
                        <div class="stat-label">Porcentaje de Cumplimiento</div>
                    </div>
                </div>

                <div class="report-section">
                    <h3>Distribución por Tipo de Actividad</h3>
                    <div id="distribucion-actividades">
                        <!-- Gráfico de distribución -->
                    </div>
                </div>

                <div class="report-section">
                    <h3>Tareas Recientes</h3>
                    <div class="list-container" id="tareas-recientes">
                        <!-- Lista de tareas recientes -->
                    </div>
                </div>

                <div class="report-section">
                    <h3>Actividades por Usuario</h3>
                    <div id="actividades-usuario">
                        <!-- Gráfico por usuario -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }

            const user = JSON.parse(currentUser);
            document.getElementById('user-greeting').textContent = `Bienvenido/a, ${user.nombre}`;
            document.getElementById('user-avatar').textContent = user.nombre.charAt(0).toUpperCase();

            setupEventListeners();
            generateReports();
        });

        function setupEventListeners() {
            document.getElementById('sidebar-nav').addEventListener('click', toggleSidebar);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('aplicar-filtros').addEventListener('click', generateReports);
            document.getElementById('export-btn').addEventListener('click', exportReport);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar-nav');
            const mainContainer = document.getElementById('main-container');
            sidebar.classList.toggle('collapsed');
            mainContainer.classList.toggle('sidebar-collapsed');
        }

        function handleLogout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        function generateReports() {
            // Obtener datos de todas las secciones
            const actividades = JSON.parse(localStorage.getItem('app_actividades-judiciales') || '[]');
            const entrevistas = JSON.parse(localStorage.getItem('app_entrevistas-clientes') || '[]');
            const otrasTareas = JSON.parse(localStorage.getItem('app_otras-tareas') || '[]');

            // Combinar todas las tareas
            const allTasks = [
                ...actividades.map(a => ({ ...a, tipo: 'Actividad Judicial', seccion: 'actividades-judiciales' })),
                ...entrevistas.map(e => ({ ...e, tipo: 'Entrevista', seccion: 'entrevistas-clientes' })),
                ...otrasTareas.map(t => ({ ...t, tipo: 'Otra Tarea', seccion: 'otras-tareas' }))
            ];

            // Aplicar filtros
            const filteredTasks = applyFilters(allTasks);

            // Calcular estadísticas
            calculateStatistics(filteredTasks);
            
            // Generar gráficos
            generateActivityDistribution(filteredTasks);
            generateRecentTasks(filteredTasks);
            generateUserActivity(allTasks);
        }

        function applyFilters(tasks) {
            const fechaDesde = document.getElementById('fecha-desde').value;
            const fechaHasta = document.getElementById('fecha-hasta').value;
            const tipo = document.getElementById('tipo-reporte').value;
            const estado = document.getElementById('estado-reporte').value;

            return tasks.filter(task => {
                // Filtrar por fecha
                if (fechaDesde) {
                    const taskDate = new Date(task.fechaActividad || task.fechaEntrevista || task.fechaTarea || task.fechaCreacion);
                    const desdeDate = new Date(fechaDesde);
                    if (taskDate < desdeDate) return false;
                }

                if (fechaHasta) {
                    const taskDate = new Date(task.fechaActividad || task.fechaEntrevista || task.fechaTarea || task.fechaCreacion);
                    const hastaDate = new Date(fechaHasta);
                    if (taskDate > hastaDate) return false;
                }

                // Filtrar por tipo
                if (tipo !== 'todos' && task.seccion !== tipo) {
                    return false;
                }

                // Filtrar por estado
                if (estado !== 'todos') {
                    if (estado === 'cumplido' && task.cumplido !== 'Sí') return false;
                    if (estado === 'pendiente' && task.pendiente !== 'Sí') return false;
                }

                return true;
            });
        }

        function calculateStatistics(tasks) {
            const total = tasks.length;
            const cumplidas = tasks.filter(t => t.cumplido === 'Sí').length;
            const pendientes = tasks.filter(t => t.pendiente === 'Sí').length;
            const porcentaje = total > 0 ? Math.round((cumplidas / total) * 100) : 0;

            document.getElementById('total-tareas').textContent = total;
            document.getElementById('tareas-cumplidas').textContent = cumplidas;
            document.getElementById('tareas-pendientes').textContent = pendientes;
            document.getElementById('porcentaje-cumplimiento').textContent = `${porcentaje}%`;
        }

        function generateActivityDistribution(tasks) {
            const distribution = {
                'Actividad Judicial': tasks.filter(t => t.seccion === 'actividades-judiciales').length,
                'Entrevista': tasks.filter(t => t.seccion === 'entrevistas-clientes').length,
                'Otra Tarea': tasks.filter(t => t.seccion === 'otras-tareas').length
            };

            const total = tasks.length;
            let html = '';

            for (const [type, count] of Object.entries(distribution)) {
                const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                html += `
                    <div class="simple-bar">
                        <div class="bar-fill" style="width: ${percentage}%">
                            ${type}: ${count} (${percentage}%)
                        </div>
                    </div>
                `;
            }

            document.getElementById('distribucion-actividades').innerHTML = html;
        }

        function generateRecentTasks(tasks) {
            // Ordenar por fecha más reciente
            const recentTasks = tasks
                .sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion))
                .slice(0, 10);

            let html = '';
            recentTasks.forEach(task => {
                const fecha = formatDateTime(task.fechaActividad || task.fechaEntrevista || task.fechaTarea || task.fechaCreacion);
                const estado = task.cumplido === 'Sí' ? '✅ Cumplida' : '⏳ Pendiente';
                
                html += `
                    <div class="list-item">
                        <h4>${task.tipo || 'Tarea'}</h4>
                        <p><strong>Descripción:</strong> ${task.detalle || task.nota || 'Sin descripción'}</p>
                        <p><strong>Fecha:</strong> ${fecha}</p>
                        <p><strong>Estado:</strong> ${estado}</p>
                        <p><strong>Creado por:</strong> ${task.creadoPor}</p>
                    </div>
                `;
            });

            document.getElementById('tareas-recientes').innerHTML = html;
        }

        function generateUserActivity(tasks) {
            const userActivity = {};
            
            tasks.forEach(task => {
                if (!userActivity[task.creadoPor]) {
                    userActivity[task.creadoPor] = 0;
                }
                userActivity[task.creadoPor]++;
            });

            const maxActivity = Math.max(...Object.values(userActivity));
            let html = '';

            for (const [user, count] of Object.entries(userActivity)) {
                const percentage = maxActivity > 0 ? Math.round((count / maxActivity) * 100) : 0;
                html += `
                    <div class="simple-bar">
                        <div class="bar-fill" style="width: ${percentage}%">
                            ${user}: ${count} tareas
                        </div>
                    </div>
                `;
            }

            document.getElementById('actividades-usuario').innerHTML = html;
        }

        function exportReport() {
            // Crear un objeto con todos los datos del reporte
            const reportData = {
                fechaGeneracion: new Date().toISOString(),
                estadisticas: {
                    totalTareas: document.getElementById('total-tareas').textContent,
                    tareasCumplidas: document.getElementById('tareas-cumplidas').textContent,
                    tareasPendientes: document.getElementById('tareas-pendientes').textContent,
                    porcentajeCumplimiento: document.getElementById('porcentaje-cumplimiento').textContent
                },
                filtros: {
                    fechaDesde: document.getElementById('fecha-desde').value,
                    fechaHasta: document.getElementById('fecha-hasta').value,
                    tipo: document.getElementById('tipo-reporte').value,
                    estado: document.getElementById('estado-reporte').value
                }
            };

            // Convertir a JSON y descargar
            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `reporte-tareas-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);

            alert('Reporte exportado exitosamente');
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            const date = new Date(dateTimeString);
            return date.toLocaleString('es-AR');
        }
    </script>
</body>
</html>